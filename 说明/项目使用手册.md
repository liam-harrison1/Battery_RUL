# 电池寿命预测项目使用手册

## 1. 命令行工具概览
```bash
python cli.py [命令] [选项]
```

### 可用命令：
| 命令    | 功能描述               |
|---------|----------------------|
| train   | 训练新模型             |
| predict | 使用训练好的模型进行预测 |
| list    | 列出所有实验记录       |

---

## 2. 完整工作流程

### 2.1 数据预处理
```bash
python preprocess.py --config configs/config.yaml
```
生成标准化序列数据到`data/processed/`目录

### 2.2 模型训练
```bash
# 训练SAETR模型
python cli.py train --model saetr

# 训练LSTM基线模型
python cli.py train --model lstm
```
**关键选项**：
- `--model`: 模型类型 (rnn/lstm/gru/transformer/saetr)
- `--config`: 配置文件路径 (默认: configs/config.yaml)

### 2.3 模型预测
```bash
# 使用实验ID预测
python cli.py predict --exp-id 3

# 使用最新实验预测
python cli.py predict --latest
```

### 2.4 实验管理
```bash
# 列出所有实验
python cli.py list
```
输出示例：
```
ID   时间                 模型      验证MAE  路径
--------------------------------------------------
1    2025-10-30 12:23:05  saetr    15.32   ./train_results/train_run_saetr_20251030_122305
2    2025-10-30 12:25:17  lstm     18.45   ./train_results/train_run_lstm_20251030_122517
```

---

## 3. 实验记录系统
### 3.1 实验记录文件 (`experiments.json`)
```json
[
  {
    "id": 1,
    "timestamp": "2025-10-30 12:23:05",
    "model": "saetr",
    "val_mae": 15.32,
    "path": "./train_results/train_run_saetr_20251030_122305",
    "config": {
      "model_params": {
        "sae_dim": 32,
        "d_model": 128,
        "nhead": 4
      },
      "train_params": {
        "batch_size": 64,
        "learning_rate": 0.001
      }
    }
  }
]
```

### 3.2 实验目录结构
```
train_run_saetr_20251030_122305/
├── checkpoints/
│   ├── best_model.pth
│   ├── scaler.json
│   └── train_config.json
└── predictions/
    ├── battery_statistics.csv
    ├── predictions_test.csv
    └── per_battery_traces/
```

---

## 4. 高级功能

### 4.1 自定义训练配置
1. 编辑`configs/config.yaml`
```yaml
model_params:
  sae_dim: 64    # 增大编码维度
  d_model: 256   # 增大Transformer维度
  nhead: 8       # 增加注意力头数

train_params:
  batch_size: 128
  learning_rate: 0.0005
```

2. 使用自定义配置训练
```bash
python cli.py train --model saetr --config configs/custom_config.yaml
```

### 4.2 结果可视化
预测完成后自动生成：
1. 预测值-真实值散点图 (`test_scatter_pred_vs_true.png`)
2. 分位数覆盖图 (`quantile_coverage.png`)
3. 电池级预测曲线 (`per_battery_traces/*.png`)

---

## 5. 典型使用场景

### 5.1 完整训练-预测流程
```bash
# 步骤1：数据预处理
python preprocess.py

# 步骤2：训练SAETR模型
python cli.py train --model saetr

# 步骤3：查看实验ID
python cli.py list

# 步骤4：使用新训练的模型预测
python cli.py predict --latest
```

### 5.2 对比不同模型
```bash
# 训练LSTM模型
python cli.py train --model lstm

# 训练Transformer模型
python cli.py train --model transformer

# 比较实验结果
python cli.py list
```

---

## 6. 常见问题处理

### 6.1 找不到实验记录
```bash
# 确保experiments.json存在
ls experiments.json

# 重新生成实验记录索引
python utils/rebuild_experiment_index.py
```

### 6.2 恢复中断的训练
```bash
# 查找检查点路径
python cli.py list

# 手动恢复训练
python train_baselines.py --model saetr --resume ./train_results/train_run_saetr_20251030_122305/checkpoints/last_checkpoint.pth