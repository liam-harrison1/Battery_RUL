# 锂离子电池RUL预测系统时序图

## 端到端工作流程
```mermaid
sequenceDiagram
    participant User
    participant Preprocess
    participant Train
    participant Predict
    participant Visualize

    User->>Preprocess: 执行数据预处理
    Preprocess->>Train: 生成序列化数据
    User->>Train: 启动模型训练
    Train->>Predict: 产出模型检查点
    User->>Predict: 运行预测脚本
    Predict->>Visualize: 生成预测结果
    Visualize-->>User: 返回可视化报告
```

## 模型推理时序
```mermaid
sequenceDiagram
    participant Input
    participant SAE
    participant CNN
    participant Transformer
    participant Head

    Input->>SAE: 原始序列 (B,L,F)
    SAE->>SAE: 特征压缩与重建
    SAE->>CNN: 编码特征 z
    CNN->>CNN: 局部特征提取
    CNN->>Transformer: 增强特征
    Transformer->>Transformer: 全局依赖建模
    Transformer->>Head: 上下文表示
    Head-->>Output: 分位数预测
```

## 训练过程时序
```mermaid
sequenceDiagram
    participant Epoch
    participant TrainStep
    participant Validate
    participant Checkpoint

    loop 每个Epoch
        Epoch->>TrainStep: 前向传播
        TrainStep->>TrainStep: 计算联合损失
        TrainStep->>TrainStep: 反向传播
        TrainStep->>Epoch: 更新参数
    end

    Epoch->>Validate: 验证集评估
    Validate->>Checkpoint: 模型性能检查
    alt 性能提升
        Checkpoint->>Checkpoint: 保存最佳模型
    else 性能下降
        Checkpoint->>Epoch: 早停计数+1
    end
```

## 关键时序说明
1. **数据预处理阶段**:
   - 原始CSV转换为标准化NPY序列
   - 生成元数据文件记录电池信息

2. **训练循环**:
   - 每个epoch包含完整的前向/反向传播
   - 验证集评估触发模型检查点保存
   - 连续`patience`次无改进触发早停

3. **预测阶段**:
   - 自动加载最新训练结果
   - 保形预测校准区间
   - 电池级轨迹可视化生成